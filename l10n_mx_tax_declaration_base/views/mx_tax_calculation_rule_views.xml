<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Vista List de Reglas de Cálculo -->
    <record id="view_mx_tax_calculation_rule_list" model="ir.ui.view">
        <field name="name">mx.tax.calculation.rule.list</field>
        <field name="model">mx.tax.calculation.rule</field>
        <field name="arch" type="xml">
            <list string="Reglas de Cálculo" create="true" edit="true" delete="true">
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="obligation_id"/>
                <field name="calculation_type"/>
                <field name="result_type"/>
                <field name="is_subtotal" widget="boolean_toggle"/>
                <field name="is_final_amount" widget="boolean_toggle"/>
                <field name="show_in_report" widget="boolean_toggle"/>
                <field name="active" widget="boolean_toggle"/>
            </list>
        </field>
    </record>

    <!-- Vista Form de Reglas de Cálculo -->
    <record id="view_mx_tax_calculation_rule_form" model="ir.ui.view">
        <field name="name">mx.tax.calculation.rule.form</field>
        <field name="model">mx.tax.calculation.rule</field>
        <field name="arch" type="xml">
            <form string="Regla de Cálculo Fiscal">
                <sheet>
                    <widget name="web_ribbon" title="Inactiva" bg_color="text-bg-danger"
                            invisible="active"/>
                    <group>
                        <group>
                            <field name="active" invisible="1"/>
                            <field name="name"/>
                            <field name="obligation_id" options="{'no_create_edit': True}"/>
                            <field name="sequence"/>
                        </group>
                        <group>
                            <field name="calculation_type"/>
                            <field name="result_type"/>
                        </group>
                    </group>

                    <notebook>
                        <page string="Configuración" name="config">
                            <!-- Configuración para suma/resta simple -->
                            <group string="Suma/Resta Simple"
                                   invisible="calculation_type not in ('simple_sum', 'simple_subtract', 'filtered_sum', 'filtered_subtract')">
                                <field name="source_model"/>
                                <field name="field_to_sum"/>
                            </group>

                            <!-- Filtros para sumas con filtro -->
                            <group string="Filtros (Dominio Odoo)"
                                   invisible="calculation_type not in ('filtered_sum', 'filtered_subtract')">
                                <field name="domain_filter" widget="domain" nolabel="1"
                                       options="{'model': 'account.move'}"/>
                                <p class="text-muted">
                                    Ejemplo de dominio manual:<br/>
                                    [('move_type', '=', 'out_invoice'), ('state', '=', 'posted')]
                                </p>
                            </group>

                            <!-- Resta entre Reglas -->
                            <group string="Resta entre Reglas"
                                   invisible="calculation_type != 'subtract'">
                                <group>
                                    <field name="operand_1"
                                           domain="[('obligation_id', '=', obligation_id), ('id', '!=', id)]"
                                           options="{'no_create_edit': True}"
                                           required="calculation_type == 'subtract'"/>
                                    <field name="operand_2"
                                           domain="[('obligation_id', '=', obligation_id), ('id', '!=', id)]"
                                           options="{'no_create_edit': True}"
                                           required="calculation_type == 'subtract'"/>
                                </group>
                                <div class="alert alert-info" role="alert">
                                    <strong>Cálculo:</strong> Operando 1 - Operando 2<br/>
                                    Ejemplo: IVA Causado - IVA Acreditable = IVA a Pagar
                                </div>
                            </group>

                            <!-- Operaciones matemáticas -->
                            <group string="Operaciones Matemáticas"
                                   invisible="calculation_type not in ('multiply', 'divide', 'percentage')">
                                <group>
                                    <field name="operand_1"
                                           domain="[('obligation_id', '=', obligation_id), ('id', '!=', id)]"
                                           options="{'no_create_edit': True}"/>
                                    <field name="operand_2"
                                           invisible="calculation_type == 'percentage'"
                                           domain="[('obligation_id', '=', obligation_id), ('id', '!=', id)]"
                                           options="{'no_create_edit': True}"/>
                                </group>
                                <group>
                                    <field name="operand_value"
                                           invisible="calculation_type not in ('multiply', 'divide', 'percentage')"/>
                                </group>
                            </group>

                            <!-- Fórmula Python -->
                            <group string="Fórmula Python"
                                   invisible="calculation_type != 'formula'">
                                <field name="python_formula" widget="ace" nolabel="1"
                                       options="{'mode': 'python'}"/>
                                <div class="alert alert-info" role="alert">
                                    <strong>Variables disponibles:</strong><br/>
                                    - <code>invoices</code>: Facturas filtradas del período<br/>
                                    - <code>payments</code>: Pagos filtrados del período<br/>
                                    - <code>rules</code>: Diccionario con resultados de otras reglas (acceso por ID)<br/>
                                    - <code>company</code>: Compañía actual<br/>
                                    - <code>period_start</code>: Fecha inicio del período<br/>
                                    - <code>period_end</code>: Fecha fin del período<br/>
                                    <br/>
                                    <strong>Funciones disponibles:</strong>
                                    sum, len, abs, min, max, round<br/>
                                    <br/>
                                    <strong>Ejemplo:</strong><br/>
                                    <code>sum(inv.amount_untaxed for inv in invoices if inv.move_type == 'out_invoice')</code>
                                </div>
                            </group>
                        </page>

                        <page string="Opciones de Visualización" name="display">
                            <group>
                                <group>
                                    <field name="show_in_report"/>
                                    <field name="is_subtotal"/>
                                    <field name="is_final_amount"/>
                                </group>
                            </group>
                            <group string="Descripción">
                                <field name="description" nolabel="1"
                                       placeholder="Describe qué calcula esta regla y para qué se utiliza..."/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Vista de Búsqueda -->
    <record id="view_mx_tax_calculation_rule_search" model="ir.ui.view">
        <field name="name">mx.tax.calculation.rule.search</field>
        <field name="model">mx.tax.calculation.rule</field>
        <field name="arch" type="xml">
            <search string="Buscar Reglas de Cálculo">
                <field name="name"/>
                <field name="obligation_id"/>
                <filter string="Activas" name="active" domain="[('active', '=', True)]"/>
                <filter string="Inactivas" name="inactive" domain="[('active', '=', False)]"/>
                <separator/>
                <filter string="Subtotales" name="subtotal" domain="[('is_subtotal', '=', True)]"/>
                <filter string="Montos Finales" name="final"
                        domain="[('is_final_amount', '=', True)]"/>
                <filter string="Mostrar en Reporte" name="show_report"
                        domain="[('show_in_report', '=', True)]"/>
                <separator/>
                <filter string="Suma Simple" name="simple_sum"
                        domain="[('calculation_type', '=', 'simple_sum')]"/>
                <filter string="Suma con Filtros" name="filtered_sum"
                        domain="[('calculation_type', '=', 'filtered_sum')]"/>
                <filter string="Fórmula Python" name="formula"
                        domain="[('calculation_type', '=', 'formula')]"/>
                <group expand="0" string="Agrupar Por">
                    <filter string="Obligación" name="group_obligation"
                            context="{'group_by': 'obligation_id'}"/>
                    <filter string="Tipo de Cálculo" name="group_calc_type"
                            context="{'group_by': 'calculation_type'}"/>
                    <filter string="Tipo de Resultado" name="group_result_type"
                            context="{'group_by': 'result_type'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Acción -->
    <record id="action_mx_tax_calculation_rule" model="ir.actions.act_window">
        <field name="name">Reglas de Cálculo</field>
        <field name="res_model">mx.tax.calculation.rule</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'search_default_active': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Crea tu primera regla de cálculo
            </p>
            <p>
                Las reglas de cálculo te permiten configurar cómo se calculan los montos
                de cada obligación fiscal. Puedes usar sumas simples, filtros complejos,
                operaciones matemáticas o fórmulas Python personalizadas.
            </p>
        </field>
    </record>

</odoo>
