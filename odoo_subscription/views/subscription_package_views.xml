<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Inherit Subscription Package Form - Add SaaS Features -->
    <record id="view_subscription_package_form_saas" model="ir.ui.view">
        <field name="name">subscription.package.form.saas</field>
        <field name="model">subscription.package</field>
        <field name="inherit_id" ref="subscription_package.view_subscription_package_form"/>
        <field name="arch" type="xml">

            <!-- Add SaaS Instance button to button_box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_instances" type="object"
                        class="oe_stat_button" icon="fa-server"
                        invisible="instance_count == 0">
                    <field name="instance_count" widget="statinfo" string="SaaS Instances"/>
                </button>
                <button name="action_provision_instance" type="object"
                        class="oe_stat_button" icon="fa-plus"
                        string="Provision Instance"
                        invisible="stage_category != 'progress' or not saas_customer_id"/>
            </xpath>

            <!-- Add SaaS Customer field in customer group -->
            <xpath expr="//field[@name='partner_id']" position="after">
                <field name="saas_customer_id"/>
            </xpath>

            <!-- Add SaaS tab before Notes tab -->
            <xpath expr="//page[@name='description']" position="before">
                <page string="SaaS Management" name="saas" invisible="not saas_customer_id">
                    <group>
                        <group string="SaaS Customer">
                            <field name="saas_customer_id" readonly="1"/>
                        </group>
                        <group string="Instances">
                            <field name="instance_count" readonly="1"/>
                        </group>
                    </group>

                    <group string="Usage-Based Billing (Metering)">
                        <field name="enable_metering"/>
                    </group>

                    <field name="saas_instance_ids" nolabel="1" invisible="not saas_customer_id">
                        <list>
                            <field name="name"/>
                            <field name="subdomain"/>
                            <field name="status"/>
                            <field name="odoo_version"/>
                            <field name="current_users"/>
                            <field name="storage_used_gb"/>
                        </list>
                    </field>
                </page>
            </xpath>

        </field>
    </record>
</odoo>
